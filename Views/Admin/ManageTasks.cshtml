@{
    ViewData["Title"] = "Manage Tasks";
}

<h1>Manage Tasks</h1>

<div class="mb-3">
    <form method="get" action="@Url.Action("ManageTasks")">
        <div class="row">
            <div class="col-md-4">
                <input type="text" name="search" class="form-control" placeholder="Search by description" value="@ViewBag.Search" />
            </div>
            <script>
                // Set the selected value based on ViewBag values
                document.addEventListener('DOMContentLoaded', function () {
                    const statusFilter = '@ViewBag.StatusFilter';
                    const sortBy = '@ViewBag.SortBy';

                    if (statusFilter) {
                        document.getElementById('statusFilter').value = statusFilter;
                    }

                    if (sortBy) {
                        document.getElementById('sortBy').value = sortBy;
                    }
                });
            </script>


            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>
</div>

<div class="alert alert-info">
    <strong>Total Tasks:</strong> @ViewBag.TaskSummaries.Total<br />
    <strong>Pending:</strong> @ViewBag.TaskSummaries.Pending<br />
    <strong>Accepted:</strong> @ViewBag.TaskSummaries.Accepted<br />
    <strong>Completed:</strong> @ViewBag.TaskSummaries.Completed<br />
    <strong>Declined:</strong> @ViewBag.TaskSummaries.Declined<br />
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <!-- Manually written column headers -->
            <th>Description</th>
            <th>Client Username</th>
            <th>Driver Username</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var task in Model)
        {
            <tr>
                <!-- Description column -->
                <td>@task.Description</td>

                <!-- Client Username column, safely checking for null -->
                <td>@(task.Client != null ? task.Client.Username : "Not Assigned")</td>

                <!-- Driver Username column, safely checking for null -->
                <td>@(task.Driver != null ? task.Driver.Username : "Not Assigned")</td>

                <!-- Status column -->
                <td>@task.Status</td>

                <!-- Action buttons for the task -->
                <td>
                    @if (task.Status == "Pending")
                    {
                        <!-- Accept and Decline buttons -->
                        <form method="post" asp-action="UpdateTaskStatus" asp-route-id="@task.Id" asp-route-status="Accepted" style="display:inline;">
                            <button type="submit" class="btn btn-success btn-sm">Accept</button>
                        </form>
                        <form method="post" asp-action="UpdateTaskStatus" asp-route-id="@task.Id" asp-route-status="Declined" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Decline</button>
                        </form>
                    }
                    else
                    {
                        <!-- Mark as Completed button -->
                        <form method="post" asp-action="UpdateTaskStatus" asp-route-id="@task.Id" asp-route-status="Completed" style="display:inline;">
                            <button type="submit" class="btn btn-primary btn-sm">Mark as Completed</button>
                        </form>
                    }
                </td>

            </tr>
        }
    </tbody>
</table>


<script>
    // Ensure the script runs after the page is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Access Razor variables and pass them to JavaScript
        const statusFilter = '@ViewBag.StatusFilter';
        const sortBy = '@ViewBag.SortBy';

        // Set the selected value based on ViewBag values
        if (statusFilter) {
            document.getElementById('statusFilter').value = statusFilter;
        }

        if (sortBy) {
            document.getElementById('sortBy').value = sortBy;
        }
    });
</script>
