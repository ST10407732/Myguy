@{
    ViewData["Title"] = "Task Details";
}

<h1>Task Details</h1>

<!-- Google Map for client to track driver -->
<div id="map"></div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner"></div>
    <p>Tracking driver...</p>
</div>

<!-- Progress Bar -->
<div class="progress" style="display: none;">
    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
</div>

<!-- Error Message for tracking failure -->
<div id="errorMessage" style="display: none; color: red;">
    <p>Driver can't be tracked.</p>
</div>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.6/signalr.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>

<script>
    let map, driverMarker, trackingTimeout;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -25.746111, lng: 28.188056 }, // Default location (Pretoria)
            zoom: 13
        });
    }

    function showLoading() {
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("progressBar").style.width = "0%";
        document.querySelector(".progress").style.display = "block";
        trackingTimeout = setTimeout(() => {
            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("errorMessage").style.display = "block";
        }, 10000);
    }

    function hideLoading() {
        clearTimeout(trackingTimeout);
        document.getElementById("loadingSpinner").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
        document.querySelector(".progress").style.display = "none";
    }

    function updateProgressBar(progress) {
        document.getElementById("progressBar").style.width = progress + "%";
    }

    const connection = new signalR.HubConnectionBuilder().withUrl("/locationHub").build();

    connection.on("ReceiveDriverLocation", function (data) {
        console.log("Driver Location Update: ", data);
        hideLoading();
        updateMap(data.driverLatitude, data.driverLongitude);
    });

    connection.start().then(() => {
        console.log("SignalR connection established.");
        updateProgressBar(50);
    }).catch(err => console.error(err.toString()));

    function sendLocationUpdate() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                showLoading();
                fetch("/account/updatelocation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ driverLatitude: latitude, driverLongitude: longitude })
                }).then(response => {
                    if (response.ok) {
                        console.log('Location sent successfully');
                        updateProgressBar(100);
                    } else {
                        console.error('Failed to send location');
                        updateProgressBar(0);
                    }
                }).catch(error => {
                    console.error('Error sending location:', error);
                    updateProgressBar(0);
                });
            }, () => {
                console.error("Unable to retrieve your location.");
                hideLoading();
                document.getElementById("errorMessage").style.display = "block";
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function updateMap(lat, lng) {
        const location = new google.maps.LatLng(lat, lng);
        if (!driverMarker) {
            driverMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: "Driver Location"
            });
        } else {
            driverMarker.setPosition(location);
        }
        map.setCenter(location);
    }

    setInterval(sendLocationUpdate, 5000);
</script>

<style>
    #map {
        height: 500px;
        width: 100%;
        border: 1px solid #ccc;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }

    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
    }

    .progress {
        margin-top: 20px;
        height: 20px;
    }

    .progress-bar {
        background-color: #4caf50;
        height: 100%;
    }

    #errorMessage {
        color: red;
        font-size: 16px;
        text-align: center;
    }
/* 

 *
    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }
</style>
