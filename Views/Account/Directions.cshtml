@model TaskRequest
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Driver Tracking</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBx_0EotM86ynL6i5HcHB6LsZOAWQIUpJM&libraries=places,directions&callback=initMap" async defer></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }

        #eta {
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2>Live Driver Tracking</h2>
    <div id="map"></div>
    <div id="eta">Calculating ETA...</div>

    <script>
        let map;
        let driverMarker;
        let directionsService;
        let directionsRenderer;
        let driverPath;
        let pickupReached = false;
        let dropoffReached = false;
        let lastUpdated = 0;
        const updateInterval = 2000;  // Update every 2 seconds
        let previousPosition = null;
        let previousTime = null;
        let lastRouteCalculated = 0;
        const routeRecalculationInterval = 60000;  // Recalculate route every 60 seconds
        const smoothFactor = 0.1;  // Smoothing factor for driver movement to avoid jitter

        function initMap() {
            var pickupLat = @Model.PickupLatitude;
            var pickupLng = @Model.PickupLongitude;
            var dropoffLat = @Model.DropoffLatitude;
            var dropoffLng = @Model.DropoffLongitude;

            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: pickupLat, lng: pickupLng },
                zoom: 14,
            });

            // Add pickup and drop-off markers
            new google.maps.Marker({
                position: { lat: pickupLat, lng: pickupLng },
                map: map,
                title: "Pickup Location",
                icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
            });

            new google.maps.Marker({
                position: { lat: dropoffLat, lng: dropoffLng },
                map: map,
                title: "Dropoff Location",
                icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
            });

            // Setup Directions API
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
            directionsRenderer.setMap(map);

            // Initialize polyline to track driver movement
            driverPath = new google.maps.Polyline({
                path: [],
                geodesic: true,
                strokeColor: "#4285F4",
                strokeOpacity: 1.0,
                strokeWeight: 5
            });
            driverPath.setMap(map);

            // Start tracking the driver
            trackDriverLocation();
        }

        function trackDriverLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(position => {
                    const driverLat = position.coords.latitude;
                    const driverLng = position.coords.longitude;
                    updateDriverLocation(driverLat, driverLng);
                }, error => {
                    console.error("Error getting location: ", error.message);
                    alert("Unable to fetch driver's location.");
                }, {
                    enableHighAccuracy: true,   // Improve accuracy
                    timeout: 10000,             // Timeout if location isn't available within 10 seconds
                    maximumAge: 0               // Don't use cached data
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function updateDriverLocation(lat, lng) {
            const now = Date.now();
            if (now - lastUpdated >= updateInterval) {
                lastUpdated = now;

                // Smooth the driver's position (to reduce jitter)
                if (previousPosition) {
                    lat = (lat * smoothFactor) + (previousPosition.lat * (1 - smoothFactor));
                    lng = (lng * smoothFactor) + (previousPosition.lng * (1 - smoothFactor));
                }

                if (driverMarker) {
                    driverMarker.setPosition({ lat: lat, lng: lng });
                } else {
                    driverMarker = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: map,
                        icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        title: "Driver's Current Location"
                    });
                }

                // Add new position to polyline path
                let path = driverPath.getPath();
                path.push(new google.maps.LatLng(lat, lng));

                // Center map to driver's latest position
                map.setCenter({ lat: lat, lng: lng });

                // Calculate route and ETA
                calculateRouteAndETA(lat, lng);
            }

            if (previousPosition) {
                const distance = google.maps.geometry.spherical.computeDistanceBetween(previousPosition, new google.maps.LatLng(lat, lng));
                const timeElapsed = (now - previousTime) / 1000;  // time in seconds
                const speed = distance / timeElapsed;  // speed in meters per second
                console.log(`Driver Speed: ${speed.toFixed(2)} m/s`);
            }
            previousPosition = new google.maps.LatLng(lat, lng);
            previousTime = now;
        }

        function calculateRouteAndETA(driverLat, driverLng) {
            const now = Date.now();
            if (now - lastRouteCalculated >= routeRecalculationInterval) {
                lastRouteCalculated = now;

                var driverLocation = new google.maps.LatLng(driverLat, driverLng);
                var pickupLocation = new google.maps.LatLng(@Model.PickupLatitude, @Model.PickupLongitude);
                var dropoffLocation = new google.maps.LatLng(@Model.DropoffLatitude, @Model.DropoffLongitude);

                let destination = pickupReached ? dropoffLocation : pickupLocation;

                var request = {
                    origin: driverLocation,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING,
                    optimizeWaypoints: true,
                };

                directionsService.route(request, function (result, status) {
                    if (status === google.maps.DirectionsStatus.OK) {
                        directionsRenderer.setDirections(result);
                        displayETA(result);

                        // Check if driver reached pickup/drop-off
                        checkArrival(driverLat, driverLng, pickupLocation, dropoffLocation);
                    } else {
                        console.error("Directions request failed: " + status);
                        alert("Unable to calculate route. Please try again later.");
                    }
                });
            }
        }

        function displayETA(result) {
            let leg = result.routes[0].legs[0];
            document.getElementById("eta").innerText = `Estimated Time to Destination: ${leg.duration.text}`;
        }

        function checkArrival(driverLat, driverLng, pickupLocation, dropoffLocation) {
            const threshold = 0.001;  // Approx. 100 meters
            const buffer = 0.0001;    // Small buffer to avoid false positives in edge cases

            let driverPos = new google.maps.LatLng(driverLat, driverLng);

            if (!pickupReached) {
                let pickupDistance = google.maps.geometry.spherical.computeDistanceBetween(driverPos, pickupLocation);
                if (pickupDistance < threshold + buffer) {
                    pickupReached = true;
                    alert("Driver has reached the pickup location!");
                }
            }

            if (pickupReached && !dropoffReached) {
                let dropoffDistance = google.maps.geometry.spherical.computeDistanceBetween(driverPos, dropoffLocation);
                if (dropoffDistance < threshold + buffer) {
                    dropoffReached = true;
                    alert("Driver has reached the drop-off location!");
                }
            }
        }
    </script>
</body>
</html>
